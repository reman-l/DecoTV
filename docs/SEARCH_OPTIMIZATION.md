# æœç´¢åŠŸèƒ½ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³æœç´¢ç»“æœä¸å‡†ç¡®çš„é—®é¢˜ï¼Œå®ç°æ™ºèƒ½æ’åºï¼š

- âœ… ç²¾ç¡®åŒ¹é…ä¼˜å…ˆæ˜¾ç¤º
- âœ… æ”¯æŒæ¨¡ç³Šæœç´¢ï¼ˆå¦‚"å XXX æµª"åŒ¹é…"åæµª"ï¼‰
- âœ… ç›¸å…³æ€§è¶Šé«˜æ’åè¶Šé å‰

## ğŸ“Š æœç´¢æ’åºè§„åˆ™

### è¯„åˆ†ç³»ç»Ÿï¼ˆæ€»åˆ† 0-110 åˆ†ï¼‰

#### 1. æ ‡é¢˜åŒ¹é…åº¦ï¼ˆä¸»è¦è¯„åˆ†ï¼š0-100 åˆ†ï¼‰

| åŒ¹é…ç±»å‹         | ç¤ºä¾‹                           | åŸºç¡€åˆ†æ•° | è¯´æ˜                         |
| ---------------- | ------------------------------ | -------- | ---------------------------- |
| **å®Œå…¨åŒ¹é…**     | æœç´¢"åæµª"ï¼Œæ‰¾åˆ°ã€Šåæµªã€‹       | 100 åˆ†   | æ ‡é¢˜å®Œå…¨ç›¸åŒï¼ˆå¿½ç•¥ç©ºæ ¼ï¼‰     |
| **å¼€å¤´åŒ¹é…**     | æœç´¢"åæµª"ï¼Œæ‰¾åˆ°ã€Šåæµªæ—¶ä»£ã€‹   | 80 åˆ†    | æ ‡é¢˜ä»¥å…³é”®è¯å¼€å¤´             |
| **åŒ…å«åŒ¹é…**     | æœç´¢"åæµª"ï¼Œæ‰¾åˆ°ã€Šæˆ‘ä»¬çš„åæµªã€‹ | 60 åˆ†    | æ ‡é¢˜åŒ…å«å®Œæ•´å…³é”®è¯           |
| **é¡ºåºæ¨¡ç³ŠåŒ¹é…** | æœç´¢"åæµª"ï¼Œæ‰¾åˆ°ã€Šåæ¥çš„æµªæ½®ã€‹ | 20-40 åˆ† | åŒ…å«å…³é”®è¯æ‰€æœ‰å­—ç¬¦ä¸”é¡ºåºä¸€è‡´ |
| **éƒ¨åˆ†å­—ç¬¦åŒ¹é…** | æœç´¢"åæµª"ï¼Œæ‰¾åˆ°ã€ŠæµªèŠ±ã€‹       | 0-15 åˆ†  | åªåŒ…å«å…³é”®è¯éƒ¨åˆ†å­—ç¬¦         |

#### 2. å¹´ä»½åŠ åˆ†ï¼ˆé¢å¤–åŠ åˆ†ï¼š0-10 åˆ†ï¼‰

- **5 å¹´å†…ä½œå“**ï¼š5-10 åˆ†ï¼ˆè¶Šæ–°åŠ åˆ†è¶Šå¤šï¼‰
- **5-10 å¹´ä½œå“**ï¼š5 åˆ†
- **10-20 å¹´ä½œå“**ï¼š2 åˆ†
- **20 å¹´ä»¥ä¸Š**ï¼š0 åˆ†

#### 3. è±†ç“£ä¿¡æ¯åŠ åˆ†ï¼ˆé¢å¤–åŠ åˆ†ï¼š5 åˆ†ï¼‰

- æœ‰è±†ç“£ ID çš„ä½œå“ï¼š+5 åˆ†
- æ— è±†ç“£ä¿¡æ¯ï¼š0 åˆ†

### æœ€ç»ˆæ’åºé€»è¾‘

```
1. æŒ‰æ€»åˆ†é™åºæ’åˆ—ï¼ˆåˆ†æ•°è¶Šé«˜è¶Šé å‰ï¼‰
2. åˆ†æ•°ç›¸åŒæ—¶ï¼ŒæŒ‰å¹´ä»½é™åºï¼ˆæ–°ä½œå“åœ¨å‰ï¼‰
3. å¹´ä»½ä¹Ÿç›¸åŒæ—¶ï¼ŒæŒ‰æ ‡é¢˜å­—æ¯é¡ºåº
```

## ğŸ” æœç´¢ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæœç´¢"åæµª"

**æ’åºç»“æœï¼š**

1. ã€Šåæµªã€‹(2024) - **110 åˆ†**

   - å®Œå…¨åŒ¹é…ï¼š100 åˆ†
   - 5 å¹´å†…ï¼š10 åˆ†

2. ã€Šåæµªæ—¶ä»£ã€‹(2023) - **95 åˆ†**

   - å¼€å¤´åŒ¹é…ï¼š80 åˆ†
   - 5 å¹´å†…ï¼š10 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

3. ã€Šæˆ‘ä»¬çš„åæµªã€‹(2022) - **75 åˆ†**

   - åŒ…å«åŒ¹é…ï¼š60 åˆ†
   - 5 å¹´å†…ï¼š10 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

4. ã€Šåæ¥çš„æµªæ½®ã€‹(2021) - **48 åˆ†**

   - é¡ºåºæ¨¡ç³Šï¼š35 åˆ†ï¼ˆç›¸ä¼¼åº¦ 75%ï¼‰
   - 5 å¹´å†…ï¼š8 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

5. ã€ŠæµªèŠ±ã€‹(2020) - **17 åˆ†**
   - éƒ¨åˆ†å­—ç¬¦ï¼š7 åˆ†ï¼ˆåŒ…å«"æµª"ï¼‰
   - 5 å¹´å†…ï¼š5 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

### ç¤ºä¾‹ 2ï¼šæœç´¢"å°æ—¶ä»£"

**æ’åºç»“æœï¼š**

1. ã€Šå°æ—¶ä»£ã€‹(2013) - **107 åˆ†**

   - å®Œå…¨åŒ¹é…ï¼š100 åˆ†
   - 10-20 å¹´ï¼š2 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

2. ã€Šå°æ—¶ä»£ 2ï¼šé’æœ¨æ—¶ä»£ã€‹(2013) - **87 åˆ†**

   - å¼€å¤´åŒ¹é…ï¼š80 åˆ†
   - 10-20 å¹´ï¼š2 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

3. ã€Šæˆ‘çš„å°æ—¶ä»£ã€‹(2020) - **70 åˆ†**
   - åŒ…å«åŒ¹é…ï¼š60 åˆ†
   - 5 å¹´å†…ï¼š5 åˆ†
   - æœ‰è±†ç“£ï¼š5 åˆ†

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç®—æ³•

#### 1. Levenshtein è·ç¦»ç®—æ³•

ç”¨äºè®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ï¼Œé€šè¿‡åŠ¨æ€è§„åˆ’è®¡ç®—æœ€å°ç¼–è¾‘è·ç¦»ã€‚

```typescript
function levenshteinDistance(str1: string, str2: string): number {
  const matrix = Array(str1.length + 1)
    .fill(null)
    .map(() => Array(str2.length + 1).fill(0));

  // åˆå§‹åŒ–
  for (let i = 0; i <= str1.length; i++) matrix[i][0] = i;
  for (let j = 0; j <= str2.length; j++) matrix[0][j] = j;

  // è®¡ç®—ç¼–è¾‘è·ç¦»
  for (let i = 1; i <= str1.length; i++) {
    for (let j = 1; j <= str2.length; j++) {
      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1, // åˆ é™¤
        matrix[i][j - 1] + 1, // æ’å…¥
        matrix[i - 1][j - 1] + cost // æ›¿æ¢
      );
    }
  }

  return matrix[str1.length][str2.length];
}
```

#### 2. é¡ºåºå­—ç¬¦åŒ¹é…

æ£€æŸ¥æ ‡é¢˜æ˜¯å¦åŒ…å«å…³é”®è¯çš„æ‰€æœ‰å­—ç¬¦ï¼ˆæŒ‰é¡ºåºï¼Œå¯é—´éš”ï¼‰ï¼š

```typescript
function containsCharsInOrder(title: string, keyword: string): boolean {
  let keywordIndex = 0;
  for (let i = 0; i < title.length && keywordIndex < keyword.length; i++) {
    if (title[i] === keyword[keywordIndex]) {
      keywordIndex++;
    }
  }
  return keywordIndex === keyword.length;
}
```

**ç¤ºä¾‹ï¼š**

- "åæ¥çš„æµªæ½®" åŒ…å« "åæµª" çš„æ‰€æœ‰å­—ç¬¦ï¼ˆå â†’ æµªï¼‰âœ…
- "æµªæ½®ä¹‹å" ä¸åŒ…å«ï¼ˆé¡ºåºä¸å¯¹ï¼‰âŒ

#### 3. ç›¸å…³æ€§è¯„åˆ†

```typescript
export function calculateRelevanceScore(
  result: SearchResult,
  query: string
): number {
  const title = result.title.trim();
  const keyword = query.trim();

  // ç§»é™¤ç©ºæ ¼
  const titleNoSpace = title.replace(/\s+/g, '');
  const keywordNoSpace = keyword.replace(/\s+/g, '');

  let score = 0;

  // 1. å®Œå…¨åŒ¹é…
  if (title === keyword || titleNoSpace === keywordNoSpace) {
    score = 100;
  }
  // 2. å¼€å¤´åŒ¹é…
  else if (
    title.startsWith(keyword) ||
    titleNoSpace.startsWith(keywordNoSpace)
  ) {
    score = 80;
  }
  // 3. åŒ…å«åŒ¹é…
  else if (title.includes(keyword) || titleNoSpace.includes(keywordNoSpace)) {
    score = 60;
  }
  // 4. æ¨¡ç³ŠåŒ¹é…
  else {
    if (containsCharsInOrder(titleNoSpace, keywordNoSpace)) {
      const similarity = similarityScore(titleNoSpace, keywordNoSpace);
      score = 20 + similarity * 20; // 20-40åˆ†
    } else {
      const matchedChars = keywordNoSpace
        .split('')
        .filter((char) => titleNoSpace.includes(char)).length;
      score = (matchedChars / keywordNoSpace.length) * 15; // 0-15åˆ†
    }
  }

  // 5. å¹´ä»½åŠ åˆ†
  const year = parseInt(result.year || '0', 10);
  if (year > 0) {
    const yearDiff = new Date().getFullYear() - year;
    if (yearDiff <= 5) score += 10 - yearDiff;
    else if (yearDiff <= 10) score += 5;
    else if (yearDiff <= 20) score += 2;
  }

  // 6. è±†ç“£åŠ åˆ†
  if (result.douban_id && result.douban_id > 0) {
    score += 5;
  }

  return Math.min(score, 110);
}
```

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ search-ranking.ts          # æœç´¢æ’åºæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ search/
â”‚           â”œâ”€â”€ route.ts           # ä¼ ç»Ÿæœç´¢ APIï¼ˆåº”ç”¨æ’åºï¼‰
â”‚           â””â”€â”€ ws/
â”‚               â””â”€â”€ route.ts       # æµå¼æœç´¢ APIï¼ˆåº”ç”¨æ’åºï¼‰
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. åç«¯æ’åºï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨

- âœ… åç«¯åœ¨è¿”å›ç»“æœå‰å®Œæˆæ’åº
- âœ… å‰ç«¯æ— éœ€é‡å¤æ’åºï¼Œå‡å°‘è®¡ç®—é‡
- âœ… æµå¼æœç´¢ä¸­ï¼Œæ¯ä¸ªæºçš„ç»“æœç‹¬ç«‹æ’åº

### 2. ç®—æ³•å¤æ‚åº¦

| æ“ä½œ             | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜                     |
| ---------------- | ---------- | ------------------------ |
| ç›¸å…³æ€§è¯„åˆ†       | O(n\*m)    | n=æ ‡é¢˜é•¿åº¦ï¼Œm=å…³é”®è¯é•¿åº¦ |
| Levenshtein è·ç¦» | O(n\*m)    | åŠ¨æ€è§„åˆ’                 |
| å…¨é‡æ’åº         | O(N log N) | N=æœç´¢ç»“æœæ•°é‡           |

**å®é™…æ€§èƒ½ï¼š**

- 100 æ¡ç»“æœæ’åºï¼š< 10ms
- 500 æ¡ç»“æœæ’åºï¼š< 50ms
- 1000 æ¡ç»“æœæ’åºï¼š< 100ms

## ğŸ“ é…ç½®è¯´æ˜

### è°ƒæ•´è¯„åˆ†æƒé‡

å¦‚éœ€è°ƒæ•´è¯„åˆ†è§„åˆ™ï¼Œä¿®æ”¹ `src/lib/search-ranking.ts`ï¼š

```typescript
// ä¿®æ”¹åŸºç¡€åˆ†æ•°
const scores = {
  exact: 100, // å®Œå…¨åŒ¹é…
  prefix: 80, // å¼€å¤´åŒ¹é…
  contains: 60, // åŒ…å«åŒ¹é…
  fuzzyMin: 20, // æ¨¡ç³ŠåŒ¹é…æœ€ä½åˆ†
  fuzzyMax: 40, // æ¨¡ç³ŠåŒ¹é…æœ€é«˜åˆ†
  partialMax: 15, // éƒ¨åˆ†åŒ¹é…æœ€é«˜åˆ†
};

// ä¿®æ”¹åŠ åˆ†è§„åˆ™
const bonusPoints = {
  year5: 10, // 5 å¹´å†…
  year10: 5, // 10 å¹´å†…
  year20: 2, // 20 å¹´å†…
  douban: 5, // æœ‰è±†ç“£ä¿¡æ¯
};
```

### ç¦ç”¨æ™ºèƒ½æ’åºï¼ˆå›é€€åˆ°æ—§ç‰ˆæœ¬ï¼‰

å¦‚éœ€ä¸´æ—¶ç¦ç”¨æ™ºèƒ½æ’åºï¼Œæ³¨é‡Šç›¸å…³ä»£ç ï¼š

```typescript
// src/app/api/search/route.ts
// flattenedResults = rankSearchResults(flattenedResults, query);

// src/app/api/search/ws/route.ts
// filteredResults = rankSearchResults(filteredResults, query);
```

## ğŸ”§ è°ƒè¯•ä¸æµ‹è¯•

### æŸ¥çœ‹è¯„åˆ†è¯¦æƒ…

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
import { calculateRelevanceScore } from '@/lib/search-ranking';

const result = { title: 'åæ¥çš„æµªæ½®', year: '2021', douban_id: 123456 };
const score = calculateRelevanceScore(result, 'åæµª');
console.log('ç›¸å…³æ€§åˆ†æ•°:', score);
```

### æµ‹è¯•æœç´¢ç»“æœ

1. æœç´¢å…³é”®è¯ï¼š"åæµª"
2. æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Network
3. æŸ¥çœ‹ `/api/search?q=åæµª` å“åº”
4. éªŒè¯ç»“æœé¡ºåºæ˜¯å¦ç¬¦åˆé¢„æœŸ

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰

æœç´¢"åæµª"çš„ç»“æœï¼ˆæŒ‰å¹´ä»½å€’åºï¼‰ï¼š

1. ã€Šåæ¥çš„æµªæ½®ã€‹(2024)
2. ã€Šæˆ‘ä»¬çš„åæµªã€‹(2023)
3. ã€Šåæµªæ—¶ä»£ã€‹(2022)
4. ã€Šåæµªã€‹(2021)
5. ã€ŠæµªèŠ±ã€‹(2020)

**é—®é¢˜ï¼š** ç²¾ç¡®åŒ¹é…ã€Šåæµªã€‹æ’åœ¨ç¬¬ 4 ä½ï¼

### ä¼˜åŒ–å

æœç´¢"åæµª"çš„ç»“æœï¼ˆæŒ‰ç›¸å…³æ€§æ’åºï¼‰ï¼š

1. ã€Šåæµªã€‹(2021) - **110 åˆ†** â­
2. ã€Šåæµªæ—¶ä»£ã€‹(2022) - **95 åˆ†**
3. ã€Šæˆ‘ä»¬çš„åæµªã€‹(2023) - **75 åˆ†**
4. ã€Šåæ¥çš„æµªæ½®ã€‹(2024) - **48 åˆ†**
5. ã€ŠæµªèŠ±ã€‹(2020) - **17 åˆ†**

**æ”¹è¿›ï¼š** ç²¾ç¡®åŒ¹é…ã€Šåæµªã€‹æ’åœ¨ç¬¬ 1 ä½ï¼âœ…

## ğŸ‰ ç”¨æˆ·ä½“éªŒæå‡

- âœ… **ç²¾ç¡®æœç´¢**ï¼šæœ"åæµª"ç›´æ¥æ‰¾åˆ°ã€Šåæµªã€‹
- âœ… **æ¨¡ç³Šæœç´¢**ï¼š"å XXX æµª"ä¹Ÿèƒ½åŒ¹é…åˆ°"åæµª"
- âœ… **æ™ºèƒ½æ’åº**ï¼šç›¸å…³æ€§è¶Šé«˜è¶Šé å‰
- âœ… **æ–°ä½œä¼˜å…ˆ**ï¼šåŒç­‰ç›¸å…³åº¦ä¸‹æ–°ä½œå“æ’å‰é¢
- âœ… **è´¨é‡ä¼˜å…ˆ**ï¼šæœ‰è±†ç“£ä¿¡æ¯çš„ä½œå“è·å¾—åŠ åˆ†

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **ç”¨æˆ·è¡Œä¸ºå­¦ä¹ **

   - è®°å½•ç”¨æˆ·ç‚¹å‡»åå¥½
   - æ ¹æ®ç‚¹å‡»ç‡è°ƒæ•´æ’åºæƒé‡

2. **åˆ†ç±»æ™ºèƒ½è¯†åˆ«**

   - è‡ªåŠ¨è¯†åˆ«æœç´¢æ„å›¾ï¼ˆç”µå½±/ç”µè§†å‰§ï¼‰
   - ä¼˜å…ˆæ˜¾ç¤ºå¯¹åº”åˆ†ç±»

3. **æœç´¢å»ºè®®ä¼˜åŒ–**

   - åŸºäºç›¸å…³æ€§æ’åºæœç´¢å»ºè®®
   - é«˜äº®åŒ¹é…å­—ç¬¦

4. **ç¼“å­˜ç­–ç•¥**

   - ç¼“å­˜çƒ­é—¨å…³é”®è¯çš„æ’åºç»“æœ
   - å‡å°‘é‡å¤è®¡ç®—

5. **A/B æµ‹è¯•**
   - å¯¹æ¯”ä¸åŒæ’åºç­–ç•¥çš„æ•ˆæœ
   - æ•°æ®é©±åŠ¨ä¼˜åŒ–å†³ç­–
